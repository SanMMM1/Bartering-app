
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Campus Marketplace Â· Static Version</title>
  <style>
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;color:#e7e9ee;background:#0f1220;}
    .bar{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:12px;backdrop-filter:blur(8px);background:rgba(10,14,30,.6);border-bottom:1px solid rgba(255,255,255,.08);}
    .brand{font-weight:800;display:flex;align-items:center;gap:8px}
    .search input{flex:1;min-width:240px;background:#0c1124;border:1px solid #223; border-radius:10px;padding:8px 10px;color:#e7e9ee}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tabs button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#e7e9ee}
    .tabs .on{background:#e7e9ee;color:#0a0f1d}
    .tabs .primary{background:linear-gradient(90deg,#6aa9ff,#97f3d2);color:#0a0f1d;border-color:transparent;font-weight:700}
    .filters{display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:8px;padding:12px;max-width:1100px;margin:8px auto 0}
    .filters select,.filters input{background:#0c1124;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px 10px;color:#e7e9ee}
    .grid{max-width:1100px;margin:0 auto;padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:16px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .img-wrap{position:relative;aspect-ratio:1/1;overflow:hidden}
    .img-wrap img{width:100%;height:100%;object-fit:cover}
    .chip{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.45);padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);font-size:12px}
    .fav{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:6px 8px;color:#fff}
    .fav.on{color:pink}
    .sold{position:absolute;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center;font-weight:800}
    .meta{padding:10px;display:flex;flex-direction:column;gap:6px}
    .title{font-weight:700;line-height:1.2}
    .price{color:#97f3d2;font-weight:800}
    .desc{opacity:.85}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .row.small{font-size:12px;opacity:.8}
    .seller{display:flex;align-items:center;gap:6px}
    .seller img{width:22px;height:22px;border-radius:999px}
    .actions button{margin-left:6px;padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#e7e9ee}
    .empty{grid-column:1/-1;text-align:center;opacity:.8;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:40px 0}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;padding:12px;z-index:20}
    .panel{background:#0b1021;border:1px solid rgba(255,255,255,.1);border-radius:16px;max-width:780px;width:100%;overflow:hidden}
    .panel-top,.panel-bottom{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .panel-bottom{border-top:1px solid rgba(255,255,255,.08);border-bottom:none}
    .panel-title{font-weight:700}
    .panel-body{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
    .form{display:flex;flex-direction:column;gap:8px}
    .field label{font-size:12px;opacity:.8}
    .field input,.field select, textarea{width:100%;background:#0c1124;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px 10px;color:#e7e9ee}
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.1)}
    .drawer{position:fixed;inset:0;z-index:30}
    .drawer .mask{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .drawer .panel{position:absolute;right:0;top:0;height:100%;width:min(420px,100%);background:#0b1021;border-left:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column}
    .chat{flex:1;overflow:auto;display:flex;flex-direction:column;gap:6px;padding:10px}
    .line{display:flex}
    .line .bubble{max-width:75%;padding:8px 10px;border-radius:14px}
    .line.me{justify-content:flex-end}
    .line.me .bubble{background:#97f3d2;color:#0a0f1d}
    .line.other .bubble{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1)}
    .ts{font-size:10px;opacity:.7;margin-top:4px}
    .send{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.08)}
    .send input{flex:1;background:#0c1124;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px 10px;color:#e7e9ee}
    .send button{padding:8px 12px;border-radius:10px;background:#fff;color:#0a0f1d}
    @media (max-width:820px){ .panel-body{grid-template-columns:1fr} .filters{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script type="text/babel">
  
const { useEffect, useMemo, useRef, useState, useCallback } = React;

// APIé…ç½®
const API_BASE_URL = 'http://localhost:3001/api';

// å·¥å…·å‡½æ•°
const uid = () => Math.random().toString(36).slice(2, 10);
const now = () => new Date().toISOString();
const timeAgo = (iso) => {
  const diff = Date.now() - new Date(iso).getTime();
  const m = Math.floor(diff / 60000);
  if (m < 1) return "just now";
  if (m < 60) return `${m} minutes ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h} hours ago`;
  const d = Math.floor(h / 24);
  if (d < 7) return `${d} days ago`;
  return new Date(iso).toLocaleDateString();
};
const fmtPrice = (n) => (Number(n) || 0).toLocaleString(undefined, { style: "currency", currency: "USD" });

// å¸¸é‡å®šä¹‰
const CATEGORIES = ["Electronics","Appliances","Furniture","Clothing","Books","Sports","Beauty & Personal Care","Tickets","Other"];
const CONDITIONS = ["Brand New","Like New","Good","Fair"];
const LOCATIONS = ["Cleveland","Columbus","Pittsburgh","Beijing","Shanghai","Guangzhou","Shunyi"];

// æœ¬åœ°å­˜å‚¨é…ç½®ï¼ˆä»…ç”¨äºç”¨æˆ·åå¥½å’Œæ”¶è—ï¼‰
const LS = { favorites:"campus_xianyu_favs", messages:"campus_xianyu_msgs", user:"campus_xianyu_user" };
const load = (k,f)=>{ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? f; }catch{ return f; } };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

// è·å–å­˜å‚¨çš„Token
const getToken = () => localStorage.getItem('auth_token');

// è®¾ç½®Token
const setToken = (token) => localStorage.setItem('auth_token', token);

// æ¸…é™¤Token
const clearToken = () => localStorage.removeItem('auth_token');

// APIè°ƒç”¨å‡½æ•°
const apiCall = async (url, options = {}) => {
  try {
    const token = getToken();
    const headers = {
      'Content-Type': 'application/json',
      ...options.headers
    };
    
    // å¦‚æœæœ‰tokenï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }
    
    const response = await fetch(`${API_BASE_URL}${url}`, {
      headers,
      ...options
    });
    
    if (!response.ok) {
      // å¦‚æœæ˜¯401é”™è¯¯ï¼Œæ¸…é™¤tokenå¹¶é‡å®šå‘åˆ°ç™»å½•
      if (response.status === 401) {
        clearToken();
        window.location.reload();
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('APIè°ƒç”¨é”™è¯¯:', error);
    throw error;
  }
};

// è®¤è¯ç›¸å…³API
const authAPI = {
  // ç”¨æˆ·æ³¨å†Œ
  register: async (userData) => {
    return await apiCall('/auth/register', {
      method: 'POST',
      body: JSON.stringify(userData)
    });
  },
  
  // ç”¨æˆ·ç™»å½•
  login: async (credentials) => {
    return await apiCall('/auth/login', {
      method: 'POST',
      body: JSON.stringify(credentials)
    });
  },
  
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  getMe: async () => {
    return await apiCall('/auth/me');
  },
  
  // æ›´æ–°ç”¨æˆ·èµ„æ–™
  updateProfile: async (profileData) => {
    return await apiCall('/auth/profile', {
      method: 'PUT',
      body: JSON.stringify(profileData)
    });
  },
  
  // ä¿®æ”¹å¯†ç 
  changePassword: async (passwordData) => {
    return await apiCall('/auth/password', {
      method: 'PUT',
      body: JSON.stringify(passwordData)
    });
  },
  
  // ç”¨æˆ·ç™»å‡º
  logout: async () => {
    return await apiCall('/auth/logout', {
      method: 'POST'
    });
  },
  
  // é‡æ–°å‘é€éªŒè¯é‚®ä»¶
  resendVerification: async () => {
    return await apiCall('/auth/resend-verification', {
      method: 'POST'
    });
  },
  
  // è¯·æ±‚å¯†ç é‡ç½®
  forgotPassword: async (email) => {
    return await apiCall('/auth/forgot-password', {
      method: 'POST',
      body: JSON.stringify({ email })
    });
  },
  
  // é‡ç½®å¯†ç 
  resetPassword: async (token, newPassword) => {
    return await apiCall('/auth/reset-password', {
      method: 'POST',
      body: JSON.stringify({ token, newPassword })
    });
  }
};

// å•†å“ç›¸å…³API
const listingsAPI = {
  // è·å–å•†å“åˆ—è¡¨
  getAll: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return await apiCall(`/listings${queryString ? '?' + queryString : ''}`);
  },
  
  // è·å–å•ä¸ªå•†å“
  getById: async (id) => {
    return await apiCall(`/listings/${id}`);
  },
  
  // åˆ›å»ºå•†å“
  create: async (listing) => {
    return await apiCall('/listings', {
      method: 'POST',
      body: JSON.stringify(listing)
    });
  },
  
  // æ›´æ–°å•†å“
  update: async (id, listing) => {
    return await apiCall(`/listings/${id}`, {
      method: 'PUT',
      body: JSON.stringify(listing)
    });
  },
  
  // åˆ é™¤å•†å“
  delete: async (id) => {
    return await apiCall(`/listings/${id}`, {
      method: 'DELETE'
    });
  },
  
  // æ ‡è®°å”®å‡ºçŠ¶æ€
  markSold: async (id, sold) => {
    return await apiCall(`/listings/${id}/sold`, {
      method: 'PATCH',
      body: JSON.stringify({ sold })
    });
  },
  
  // è·å–ç”¨æˆ·å•†å“
  getByUser: async (userId, sold = null) => {
    const params = sold !== null ? { sold } : {};
    const queryString = new URLSearchParams(params).toString();
    return await apiCall(`/listings/user/${userId}${queryString ? '?' + queryString : ''}`);
  }
};
function App(){
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [listings, setListings] = useState([]);
  const [favorites, setFavorites] = useState(()=> load(LS.favorites, {}));
  const [messages, setMessages] = useState(()=> load(LS.messages, {}));
  const [q,setQ] = useState(""); const [cat,setCat] = useState("All"); const [cond,setCond] = useState("All"); const [loc,setLoc] = useState("All");
  const [minp,setMinp] = useState(""); const [maxp,setMaxp] = useState(""); const [sort,setSort] = useState("Latest"); const [tab,setTab] = useState("explore");
  const [posting,setPosting] = useState(false); const [chatFor,setChatFor] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [showLogin, setShowLogin] = useState(false);
  const [showRegister, setShowRegister] = useState(false);
  const [showVerification, setShowVerification] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  
  // ä¿å­˜ç”¨æˆ·åå¥½åˆ°localStorage
  useEffect(()=>save(LS.favorites, favorites),[favorites]);
  useEffect(()=>save(LS.messages, messages),[messages]);
  useEffect(()=>save(LS.user, user),[user]);
  
  // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
  const checkAuth = useCallback(async () => {
    const token = getToken();
    if (token) {
      try {
        const response = await authAPI.getMe();
        if (response.success) {
          setUser(response.data);
          setIsAuthenticated(true);
        } else {
          clearToken();
        }
      } catch (error) {
        console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
        clearToken();
      }
    }
  }, []);
  
  // ç”¨æˆ·ç™»å½•
  const handleLogin = async (credentials) => {
    try {
      const response = await authAPI.login(credentials);
      if (response.success) {
        setToken(response.data.token);
        setUser(response.data.user);
        setIsAuthenticated(true);
        setShowLogin(false);
        setError(null);
      } else {
        setError(response.message || 'ç™»å½•å¤±è´¥');
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error);
      setError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  
  // ç”¨æˆ·æ³¨å†Œ
  const handleRegister = async (userData) => {
    try {
      const response = await authAPI.register(userData);
      if (response.success) {
        setToken(response.data.token);
        setUser(response.data.user);
        setIsAuthenticated(true);
        setShowRegister(false);
        setError(null);
        
        // å¦‚æœé‚®ç®±éªŒè¯é‚®ä»¶å‘é€æˆåŠŸï¼Œæ˜¾ç¤ºéªŒè¯æç¤º
        if (response.data.emailSent) {
          setShowVerification(true);
        }
      } else {
        setError(response.message || 'æ³¨å†Œå¤±è´¥');
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error);
      setError('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  
  // ç”¨æˆ·ç™»å‡º
  const handleLogout = async () => {
    try {
      await authAPI.logout();
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error);
    } finally {
      clearToken();
      setUser(null);
      setIsAuthenticated(false);
      setError(null);
    }
  };
  
  // é‡æ–°å‘é€éªŒè¯é‚®ä»¶
  const handleResendVerification = async () => {
    try {
      const response = await authAPI.resendVerification();
      if (response.success) {
        setError(null);
        alert('éªŒè¯é‚®ä»¶å·²é‡æ–°å‘é€ï¼Œè¯·æŸ¥æ”¶æ‚¨çš„é‚®ç®±');
      } else {
        setError(response.message || 'é‡æ–°å‘é€å¤±è´¥');
      }
    } catch (error) {
      console.error('é‡æ–°å‘é€éªŒè¯é‚®ä»¶å¤±è´¥:', error);
      setError('é‡æ–°å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  
  // è¯·æ±‚å¯†ç é‡ç½®
  const handleForgotPassword = async (email) => {
    try {
      const response = await authAPI.forgotPassword(email);
      if (response.success) {
        setError(null);
        alert('å¯†ç é‡ç½®é‚®ä»¶å·²å‘é€ï¼Œè¯·æŸ¥æ”¶æ‚¨çš„é‚®ç®±');
        setShowForgotPassword(false);
      } else {
        setError(response.message || 'å‘é€å¤±è´¥');
      }
    } catch (error) {
      console.error('è¯·æ±‚å¯†ç é‡ç½®å¤±è´¥:', error);
      setError('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  
  // åˆå§‹æ£€æŸ¥è®¤è¯çŠ¶æ€
  useEffect(() => {
    checkAuth();
  }, [checkAuth]);
  
  // ä»APIåŠ è½½å•†å“æ•°æ®
  const loadListings = useCallback(async (params = {}) => {
    setLoading(true);
    setError(null);
    try {
      const response = await listingsAPI.getAll(params);
      if (response.success) {
        setListings(response.data);
      } else {
        setError('åŠ è½½å•†å“æ•°æ®å¤±è´¥');
      }
    } catch (err) {
      console.error('åŠ è½½å•†å“å¤±è´¥:', err);
      setError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ');
    } finally {
      setLoading(false);
    }
  }, []);
  
  // åˆå§‹åŠ è½½æ•°æ®
  useEffect(() => {
    loadListings();
  }, [loadListings]);
  // æ„å»ºAPIæŸ¥è¯¢å‚æ•°
  const apiParams = useMemo(() => {
    const params = {};
    if (cat !== "All") params.category = cat;
    if (cond !== "All") params.condition = cond;
    if (loc !== "All") params.location = loc;
    if (minp) params.minPrice = minp;
    if (maxp) params.maxPrice = maxp;
    if (q.trim()) params.search = q.trim();
    
    // æ’åºå‚æ•°
    if (sort === "Price â†‘") {
      params.sort = "price";
      params.order = "asc";
    } else if (sort === "Price â†“") {
      params.sort = "price";
      params.order = "desc";
    } else {
      params.sort = "createdAt";
      params.order = "desc";
    }
    
    return params;
  }, [cat, cond, loc, minp, maxp, q, sort]);

  // åŠ è½½ç”¨æˆ·å•†å“
  const loadUserListings = useCallback(async () => {
    if (!user?.id) return;
    
    setLoading(true);
    setError(null);
    try {
      const response = await listingsAPI.getByUser(user.id);
      if (response.success) {
        setListings(response.data);
      } else {
        setError('åŠ è½½ç”¨æˆ·å•†å“å¤±è´¥');
      }
    } catch (err) {
      console.error('åŠ è½½ç”¨æˆ·å•†å“å¤±è´¥:', err);
      setError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
    } finally {
      setLoading(false);
    }
  }, [user?.id]);

  // å½“ç­›é€‰æ¡ä»¶æ”¹å˜æ—¶é‡æ–°åŠ è½½æ•°æ®
  useEffect(() => {
    if (tab === "explore") {
      loadListings(apiParams);
    } else if (tab === "mine") {
      loadUserListings();
    }
  }, [apiParams, tab, loadListings, loadUserListings]);


  // å®¢æˆ·ç«¯ç­›é€‰æ•°æ®ï¼ˆç”¨äºæ”¶è—å’Œæœç´¢ï¼‰
  const data = useMemo(() => {
    let d = [...listings];
    
    if (tab === "favorites") {
      d = d.filter(it => favorites[it._id || it.id]);
    }
    
    // å¦‚æœAPIä¸æ”¯æŒæœç´¢ï¼Œåˆ™è¿›è¡Œå®¢æˆ·ç«¯æœç´¢
    if (q.trim() && !apiParams.search) {
      const key = q.trim().toLowerCase();
      d = d.filter(it => 
        (`${it.title} ${it.description || it.desc}`).toLowerCase().includes(key)
      );
    }
    
    return d;
  }, [listings, favorites, tab, q, apiParams.search]);
  const toggleFav = (id)=> setFavorites(f=>({ ...f, [id]: !f[id] }));
  
  const handlePost = async (item) => {
    if (!user?.id) {
      setError('è¯·å…ˆç™»å½•');
      return;
    }
    
    try {
      const newItem = {
        ...item,
        seller: {
          id: user.id,
          name: user.name,
          avatar: user.avatar
        }
      };
      
      const response = await listingsAPI.create(newItem);
      if (response.success) {
        // é‡æ–°åŠ è½½æ•°æ®
        if (tab === "mine") {
          loadUserListings();
        } else {
          loadListings(); // é‡æ–°åŠ è½½æ‰€æœ‰å•†å“
        }
        setPosting(false);
        setTab("mine");
      } else {
        setError('å‘å¸ƒå•†å“å¤±è´¥');
      }
    } catch (err) {
      console.error('å‘å¸ƒå•†å“å¤±è´¥:', err);
      setError('å‘å¸ƒå•†å“å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  
  const markSold = async (id, sold = true) => {
    try {
      const response = await listingsAPI.markSold(id, sold);
      if (response.success) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        setListings(arr => arr.map(it => (it._id || it.id) === id ? {...it, sold} : it));
      } else {
        setError('æ›´æ–°å•†å“çŠ¶æ€å¤±è´¥');
      }
    } catch (err) {
      console.error('æ›´æ–°å•†å“çŠ¶æ€å¤±è´¥:', err);
      setError('æ›´æ–°å•†å“çŠ¶æ€å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  
  const removeItem = async (id) => {
    try {
      const response = await listingsAPI.delete(id);
      if (response.success) {
        // é‡æ–°åŠ è½½æ•°æ®
        if (tab === "mine") {
          loadUserListings();
        } else {
          loadListings(); // é‡æ–°åŠ è½½æ‰€æœ‰å•†å“
        }
      } else {
        setError('åˆ é™¤å•†å“å¤±è´¥');
      }
    } catch (err) {
      console.error('åˆ é™¤å•†å“å¤±è´¥:', err);
      setError('åˆ é™¤å•†å“å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };
  const sendMsg = (listingId,text)=>{
    if(!text.trim()) return;
    if (!user?.id) {
      setError('è¯·å…ˆç™»å½•');
      return;
    }
    setMessages(m=>{ 
      const arr = m[listingId]?[...m[listingId]]:[]; 
      arr.push({ id: uid(), from: user.id, text, at: now() });
      setTimeout(()=>{ 
        setMessages(mm=>{ 
          const back = mm[listingId]?[...mm[listingId]]:[]; 
          back.push({ id: uid(), from: "seller", text: "Sure, I'm available for pickup~", at: now() }); 
          return { ...mm, [listingId]: back }; 
        }); 
      }, 400);
      return { ...m, [listingId]: arr };
    });
  };
  const ItemCard = ({ item }) => (
    <div className="card">
      <div className="img-wrap">
        <img src={item.images?.[0]} alt={item.title}/>
        <div className="chip">{item.category}</div>
        <button className={"fav"+(favorites[item._id || item.id]?" on":"")} onClick={()=>toggleFav(item._id || item.id)}>â™¥</button>
        {item.sold && <div className="sold">Sold</div>}
      </div>
      <div className="meta">
        <div className="title">{item.title}</div>
        <div className="price">{fmtPrice(item.price)}</div>
        <div className="desc">{item.description || item.desc}</div>
        <div className="row">
          <div className="seller"><img src={item.seller?.avatar}/><span>{item.seller?.name}</span></div>
          <div className="loc">{item.location}</div>
        </div>
        <div className="row small">
          <span>{item.condition} Â· {timeAgo(item.createdAt)}</span>
          <div className="actions">
            <button onClick={()=>setChatFor(item)}>Chat</button>
            {item.seller?.id===user?.id && !item.sold && <button onClick={()=>markSold(item._id || item.id,true)}>Mark Sold</button>}
            {item.seller?.id===user?.id && item.sold && <button onClick={()=>markSold(item._id || item.id,false)}>Unmark Sold</button>}
            {item.seller?.id===user?.id && <button onClick={()=>removeItem(item._id || item.id)}>Delete</button>}
          </div>
        </div>
      </div>
    </div>
  );
  return (
    <>
      <div className="bar">
        <div className="brand">â— Campus Marketplace Â· MongoDB</div>
        <div className="search"><input placeholder="Search: title/description..." value={q} onChange={e=>setQ(e.target.value)} /></div>
        <div className="tabs">
          <button className={tab==='explore'?'on':''} onClick={()=>setTab('explore')}>Explore</button>
          {isAuthenticated && (
            <>
              <button className={tab==='favorites'?'on':''} onClick={()=>setTab('favorites')}>Favorites</button>
              <button className={tab==='mine'?'on':''} onClick={()=>setTab('mine')}>My Items</button>
              <button className="primary" onClick={()=>{if(user?.id) setPosting(true); else setError('è¯·å…ˆç™»å½•');}}>ï¼‹ Post</button>
            </>
          )}
          {!isAuthenticated ? (
            <>
              <button onClick={()=>setShowLogin(true)}>Login</button>
              <button className="primary" onClick={()=>setShowRegister(true)}>Register</button>
            </>
          ) : (
            <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
              <span style={{fontSize: '14px'}}>Hi, {user?.name}</span>
              {!user?.isVerified && (
                <button onClick={handleResendVerification} style={{fontSize: '12px', padding: '4px 8px'}}>
                  éªŒè¯é‚®ç®±
                </button>
              )}
              <button onClick={handleLogout}>Logout</button>
            </div>
          )}
        </div>
      </div>
      {error && (
        <div style={{background: '#ff6b6b', color: 'white', padding: '8px', textAlign: 'center', fontSize: '14px'}}>
          âš ï¸ {error} - è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (http://localhost:3001)
        </div>
      )}
      <div className="filters">
        <select value={cat} onChange={e=>setCat(e.target.value)}><option>All</option>{CATEGORIES.map(c=><option key={c}>{c}</option>)}</select>
        <select value={cond} onChange={e=>setCond(e.target.value)}><option>All</option>{CONDITIONS.map(c=><option key={c}>{c}</option>)}</select>
        <select value={loc} onChange={e=>setLoc(e.target.value)}><option>All</option>{LOCATIONS.map(c=><option key={c}>{c}</option>)}</select>
        <input placeholder="Min Price" value={minp} onChange={e=>setMinp(e.target.value)} />
        <input placeholder="Max Price" value={maxp} onChange={e=>setMaxp(e.target.value)} />
        <select value={sort} onChange={e=>setSort(e.target.value)}><option>Latest</option><option>Price â†‘</option><option>Price â†“</option></select>
      </div>
      <div className="grid">
        {loading ? (
          <div className="empty">åŠ è½½ä¸­...</div>
        ) : error ? (
          <div className="empty" style={{color: '#ff6b6b'}}>
            {error}
            <br/>
            <button onClick={() => window.location.reload()} style={{marginTop: '10px', padding: '8px 16px', background: '#97f3d2', color: '#0a0f1d', border: 'none', borderRadius: '8px', cursor: 'pointer'}}>
              é‡æ–°åŠ è½½
            </button>
          </div>
        ) : data.length === 0 ? (
          <div className="empty">No items found matching your criteria.</div>
        ) : (
          data.map(it => <ItemCard key={it._id || it.id} item={it}/>)
        )}
      </div>
      {posting && <PostModal onClose={()=>setPosting(false)} onPost={(item)=>{ handlePost(item); }}/>} 
      {chatFor && <ChatDrawer item={chatFor} onClose={()=>setChatFor(null)} messages={messages[chatFor._id || chatFor.id]||[]} onSend={(id,text)=>sendMsg(id,text)} user={user} />}
      {showLogin && <LoginModal onClose={()=>setShowLogin(false)} onLogin={handleLogin} onSwitchToRegister={()=>{setShowLogin(false); setShowRegister(true);}} onForgotPassword={()=>{setShowLogin(false); setShowForgotPassword(true);}} />}
      {showRegister && <RegisterModal onClose={()=>setShowRegister(false)} onRegister={handleRegister} onSwitchToLogin={()=>{setShowRegister(false); setShowLogin(true);}} />}
      {showVerification && <VerificationModal onClose={()=>setShowVerification(false)} user={user} onResend={handleResendVerification} />}
      {showForgotPassword && <ForgotPasswordModal onClose={()=>setShowForgotPassword(false)} onSubmit={handleForgotPassword} onSwitchToLogin={()=>{setShowForgotPassword(false); setShowLogin(true);}} />}
    </>
  );
}
function PostModal({ onClose, onPost }){
  const { useState, useRef, useEffect } = React;
  const [title,setTitle]=useState(""); const [price,setPrice]=useState(""); const [category,setCategory]=useState(CATEGORIES[0]);
  const [condition,setCondition]=useState(CONDITIONS[1]); const [location,setLocation]=useState(LOCATIONS[0]); const [desc,setDesc]=useState("");
  const [images,setImages]=useState([]);
  const toBase64 = (file) => new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = rej; reader.readAsDataURL(file); });
  const handleFiles = async (files) => { const arr=[]; for (const f of files){ if (!f.type.startsWith("image/")) continue; const b64 = await toBase64(f); arr.push(b64);} setImages(prev=>[...prev,...arr].slice(0,6)); };
  const submit = () => { 
    if (!title.trim() || !price) return alert("Please fill in title and price"); 
    onPost({ 
      title, 
      price: Number(price), 
      category, 
      condition, 
      location, 
      description: desc, // ä½¿ç”¨descriptionå­—æ®µå
      images: images.length ? images : ["https://images.unsplash.com/photo-1555041469-a586c61ea9bc?q=80&w=1200&auto=format&fit=crop"] 
    }); 
  };
  return (
    <div className="modal">
      <div className="panel">
        <div className="panel-top"><div className="panel-title">Post Item</div><button onClick={onClose}>Ã—</button></div>
        <div className="panel-body">
          <div className="form">
            <div className="field"><label>Title</label><input value={title} onChange={e=>setTitle(e.target.value)} placeholder="e.g.: iPad Air 5 64GB Blue"/></div>
            <div className="field"><label>Price (USD)</label><input value={price} onChange={e=>setPrice(e.target.value)} type="number" placeholder="e.g.: 360"/></div>
            <div className="field"><label>Category</label><select value={category} onChange={e=>setCategory(e.target.value)}>{CATEGORIES.map(o=><option key={o}>{o}</option>)}</select></div>
            <div className="field"><label>Condition</label><select value={condition} onChange={e=>setCondition(e.target.value)}>{CONDITIONS.map(o=><option key={o}>{o}</option>)}</select></div>
            <div className="field"><label>Location</label><select value={location} onChange={e=>setLocation(e.target.value)}>{LOCATIONS.map(o=><option key={o}>{o}</option>)}</select></div>
          </div>
          <div className="form">
            <label>Description</label>
            <textarea value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Highlights, condition, accessories, transaction method..."></textarea>
            <label>Images (max 6)</label>
            <div className="thumbs">
              {images.map((src,i)=><img key={i} src={src} className="thumb"/>)}
              <input type="file" accept="image/*" multiple onChange={e=>handleFiles(e.target.files)} />
            </div>
          </div>
        </div>
        <div className="panel-bottom"><button onClick={onClose}>Cancel</button><button onclick="void(0)" className="primary" onClick={submit}>Post</button></div>
      </div>
    </div>
  );
}
function ChatDrawer({ item, onClose, messages, onSend, user }){
  const { useState, useRef, useEffect } = React;
  const [text,setText] = useState("");
  const ref = useRef(null);
  useEffect(()=>ref.current?.scrollIntoView({behavior:"smooth"}),[messages]);
  return (
    <div className="drawer">
      <div className="mask" onClick={onClose}></div>
      <div className="panel">
        <div className="panel-top"><button onClick={onClose}>Ã—</button><div>{item.seller?.name} Â· {item.title}</div></div>
        <div className="chat">
          {(messages||[]).map(m=>(
            <div key={m.id} className={"line "+(m.from===user?.id?"me":"other")}>
              <div className="bubble">{m.text}<div className="ts">{timeAgo(m.at)}</div></div>
            </div>
          ))}
          <div ref={ref}></div>
        </div>
        <div className="send">
          <input value={text} onChange={e=>setText(e.target.value)} placeholder="Send message..."/>
          <button onClick={()=>{ onSend(item.id, text); setText(""); }}>Send</button>
        </div>
      </div>
    </div>
  );
}
// ç™»å½•æ¨¡æ€æ¡†ç»„ä»¶
function LoginModal({ onClose, onLogin, onSwitchToRegister, onForgotPassword }) {
  const { useState } = React;
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!email || !password) return alert("è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ");
    
    setLoading(true);
    try {
      await onLogin({ email, password });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="modal">
      <div className="panel">
        <div className="panel-top">
          <div className="panel-title">ç™»å½•</div>
          <button onClick={onClose}>Ã—</button>
        </div>
        <div className="panel-body">
          <form onSubmit={handleSubmit} className="form">
            <div className="field">
              <label>é‚®ç®±</label>
              <input 
                type="email" 
                value={email} 
                onChange={e => setEmail(e.target.value)} 
                placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€"
                required
              />
            </div>
            <div className="field">
              <label>å¯†ç </label>
              <input 
                type="password" 
                value={password} 
                onChange={e => setPassword(e.target.value)} 
                placeholder="è¯·è¾“å…¥å¯†ç "
                required
              />
            </div>
            <div className="panel-bottom">
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', width: '100%'}}>
                <button type="button" onClick={onSwitchToRegister}>æ³¨å†Œæ–°è´¦å·</button>
                <button type="button" onClick={onForgotPassword} style={{fontSize: '12px', color: '#666'}}>å¿˜è®°å¯†ç ï¼Ÿ</button>
              </div>
              <button type="submit" className="primary" disabled={loading}>
                {loading ? "ç™»å½•ä¸­..." : "ç™»å½•"}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}

// æ³¨å†Œæ¨¡æ€æ¡†ç»„ä»¶
function RegisterModal({ onClose, onRegister, onSwitchToLogin }) {
  const { useState } = React;
  const [formData, setFormData] = useState({
    email: "",
    password: "",
    confirmPassword: "",
    name: "",
    phone: ""
  });
  const [loading, setLoading] = useState(false);

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.email || !formData.password || !formData.name) {
      return alert("è¯·å¡«å†™å¿…å¡«å­—æ®µ");
    }
    
    if (formData.password !== formData.confirmPassword) {
      return alert("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´");
    }
    
    if (formData.password.length < 6) {
      return alert("å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦");
    }
    
    setLoading(true);
    try {
      const { confirmPassword, ...userData } = formData;
      // è¿‡æ»¤æ‰ç©ºçš„æ‰‹æœºå·
      if (!userData.phone || userData.phone.trim() === '') {
        delete userData.phone;
      }
      await onRegister(userData);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="modal">
      <div className="panel">
        <div className="panel-top">
          <div className="panel-title">æ³¨å†Œ</div>
          <button onClick={onClose}>Ã—</button>
        </div>
        <div className="panel-body">
          <form onSubmit={handleSubmit} className="form">
            <div className="field">
              <label>é‚®ç®± *</label>
              <input 
                type="email" 
                value={formData.email} 
                onChange={e => handleChange('email', e.target.value)} 
                placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€"
                required
              />
            </div>
            <div className="field">
              <label>ç”¨æˆ·å *</label>
              <input 
                type="text" 
                value={formData.name} 
                onChange={e => handleChange('name', e.target.value)} 
                placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                required
              />
            </div>
            <div className="field">
              <label>æ‰‹æœºå·</label>
              <input 
                type="tel" 
                value={formData.phone} 
                onChange={e => handleChange('phone', e.target.value)} 
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰"
              />
            </div>
            <div className="field">
              <label>å¯†ç  *</label>
              <input 
                type="password" 
                value={formData.password} 
                onChange={e => handleChange('password', e.target.value)} 
                placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰"
                required
              />
            </div>
            <div className="field">
              <label>ç¡®è®¤å¯†ç  *</label>
              <input 
                type="password" 
                value={formData.confirmPassword} 
                onChange={e => handleChange('confirmPassword', e.target.value)} 
                placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                required
              />
            </div>
            <div className="panel-bottom">
              <button type="button" onClick={onSwitchToLogin}>å·²æœ‰è´¦å·ï¼Ÿç™»å½•</button>
              <button type="submit" className="primary" disabled={loading}>
                {loading ? "æ³¨å†Œä¸­..." : "æ³¨å†Œ"}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}

// é‚®ç®±éªŒè¯æ¨¡æ€æ¡†ç»„ä»¶
function VerificationModal({ onClose, user, onResend }) {
  const { useState } = React;
  const [loading, setLoading] = useState(false);

  const handleResend = async () => {
    setLoading(true);
    try {
      await onResend();
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="modal">
      <div className="panel">
        <div className="panel-top">
          <div className="panel-title">ğŸ“§ é‚®ç®±éªŒè¯</div>
          <button onClick={onClose}>Ã—</button>
        </div>
        <div className="panel-body">
          <div style={{textAlign: 'center', padding: '20px'}}>
            <div style={{fontSize: '48px', marginBottom: '20px'}}>ğŸ“¬</div>
            <h3 style={{color: '#333', marginBottom: '15px'}}>éªŒè¯é‚®ä»¶å·²å‘é€</h3>
            <p style={{color: '#666', lineHeight: '1.6', marginBottom: '20px'}}>
              æˆ‘ä»¬å·²å‘ <strong>{user?.email}</strong> å‘é€äº†ä¸€å°éªŒè¯é‚®ä»¶ã€‚
              <br/>è¯·æŸ¥æ”¶æ‚¨çš„é‚®ç®±å¹¶ç‚¹å‡»éªŒè¯é“¾æ¥å®Œæˆæ³¨å†Œã€‚
            </p>
            
            <div style={{background: '#e3f2fd', border: '1px solid #bbdefb', borderRadius: '5px', padding: '15px', margin: '20px 0'}}>
              <p style={{margin: '0', color: '#1976d2', fontSize: '14px'}}>
                <strong>ğŸ’¡ æç¤ºï¼š</strong><br/>
                â€¢ éªŒè¯é“¾æ¥24å°æ—¶å†…æœ‰æ•ˆ<br/>
                â€¢ å¦‚æœæ²¡æœ‰æ”¶åˆ°é‚®ä»¶ï¼Œè¯·æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹<br/>
                â€¢ éªŒè¯åå³å¯æ­£å¸¸ä½¿ç”¨å¹³å°æ‰€æœ‰åŠŸèƒ½
              </p>
            </div>
            
            <div style={{display: 'flex', gap: '10px', justifyContent: 'center'}}>
              <button onClick={handleResend} disabled={loading} style={{fontSize: '14px'}}>
                {loading ? "å‘é€ä¸­..." : "é‡æ–°å‘é€"}
              </button>
              <button onClick={onClose} className="primary">
                æˆ‘çŸ¥é“äº†
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// å¿˜è®°å¯†ç æ¨¡æ€æ¡†ç»„ä»¶
function ForgotPasswordModal({ onClose, onSubmit, onSwitchToLogin }) {
  const { useState } = React;
  const [email, setEmail] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!email) return alert("è¯·è¾“å…¥é‚®ç®±åœ°å€");
    
    setLoading(true);
    try {
      await onSubmit(email);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="modal">
      <div className="panel">
        <div className="panel-top">
          <div className="panel-title">ğŸ”‘ å¿˜è®°å¯†ç </div>
          <button onClick={onClose}>Ã—</button>
        </div>
        <div className="panel-body">
          <form onSubmit={handleSubmit} className="form">
            <div style={{textAlign: 'center', marginBottom: '20px'}}>
              <div style={{fontSize: '48px', marginBottom: '15px'}}>ğŸ”’</div>
              <p style={{color: '#666', lineHeight: '1.6'}}>
                è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼Œæˆ‘ä»¬å°†å‘é€å¯†ç é‡ç½®é“¾æ¥ç»™æ‚¨ã€‚
              </p>
            </div>
            
            <div className="field">
              <label>é‚®ç®±åœ°å€</label>
              <input 
                type="email" 
                value={email} 
                onChange={e => setEmail(e.target.value)} 
                placeholder="è¯·è¾“å…¥æ³¨å†Œæ—¶ä½¿ç”¨çš„é‚®ç®±"
                required
              />
            </div>
            
            <div className="panel-bottom">
              <button type="button" onClick={onSwitchToLogin}>è¿”å›ç™»å½•</button>
              <button type="submit" className="primary" disabled={loading}>
                {loading ? "å‘é€ä¸­..." : "å‘é€é‡ç½®é“¾æ¥"}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));

  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
